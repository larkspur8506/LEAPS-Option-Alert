# QQQ Option Alert - 提醒功能测试指南

## 📋 测试脚本说明

测试脚本位置：`tests/test_alerts.py`

该脚本可以完整测试所有提醒功能，包括：
- ✅ QQQ 跌幅规则（4 条）
- ✅ 期权规则（止盈/止损/时间风险/最大持仓）
- ✅ 去重机制
- ✅ 企业微信推送（可选）
- ✅ Polygon.io API（可选）

---

## 🚀 运行测试

### 方法 1：直接运行

```powershell
cd "/d/LEAPS Option Alert"
python tests/test_alerts.py
```

### 方法 2：使用虚拟环境

```powershell
cd "/d/LEAPS Option Alert"
.\venv\Scripts\Activate.ps1
python tests/test_alerts.py
```

---

## 📊 测试内容

### 1️⃣ QQQ 跌幅规则测试

**测试场景**：
- **场景 1**：触发 Rule A（昨日收盘 → 当前价 -2%）
- **场景 2**：同时触发所有 QQQ 规则（A/B/C/D）

**验证点**：
- 规则触发逻辑正确
- 跌幅计算准确
- 触发价格正确

---

### 2️⃣ 期权规则测试

**测试场景**：
- **场景 1**：止盈触发（阶段1，+50%）
- **场景 2**：止损触发（-30%）
- **场景 3**：时间风险触发（DTE ≤ 45 天）
- **场景 4**：无触发（正常情况）

**验证点**：
- 止盈阈值计算正确
- 止损阈值计算正确
- DTE 计算正确
- 规则不误触发

---

### 3️⃣ 去重机制测试

**测试场景**：
- 同一天同一规则只提醒一次
- 同一天不同规则可以分别提醒
- 同一规则不同仓位可以分别提醒

**验证点**：
- 去重逻辑正确
- 不会重复提醒

---

### 4️⃣ 企业微信推送测试（可选）

**测试场景**：
- 发送 QQQ 跌幅提醒
- 发送期权止盈提醒

**验证点**：
- Webhook 调用成功
- 消息格式正确
- 企业微信收到消息

---

### 5️⃣ Polygon.io API 测试（可选）

**测试场景**：
- 获取昨日收盘价
- 获取实时价格
- 获取历史数据

**验证点**：
- API 调用成功
- 数据格式正确
- 缓存功能正常

---

## 🎯 预期输出

```
============================================================
🧪 QQQ Option Alert - 提醒功能测试
============================================================
测试时间: 2026-01-24 16:30:00 EST

============================================================
📊 测试 QQQ 跌幅规则
============================================================

【场景 1】触发 Rule A
模拟数据:
  当前价: $450.00
  昨日收盘: $460.00
  跌幅: -2.17%

触发提醒数量: 1

  ✅ Rule A: 昨日收盘 → 当前价
     触发价: $450.00
     跌幅: -2.17%

【场景 2】触发所有 QQQ 规则
模拟数据:
  当前价: $440.00
  昨日收盘: $450.00
  当日最高: $450.00
  3日高点: $450.00
  2日前收盘: $449.00

触发提醒数量: 4

  ✅ Rule A: 昨日收盘 → 当前价
     触发价: $440.00
     跌幅: -2.22%

  ✅ Rule B: 当日最高 → 当前价
     触发价: $440.00
     跌幅: -2.22%

  ✅ Rule C: 2日前Close → 当前价 (累计≥-2%)
     触发价: $440.00
     跌幅: -2.00%

  ✅ Rule D: 3日滚动高点 → 当前价
     触发价: $440.00
     跌幅: -2.22%

============================================================
📈 测试期权规则
============================================================

【场景 1】止盈触发（阶段1）
...
```

---

## 📋 测试清单

运行测试后，验证以下内容：

- [ ] QQQ Rule A 触发
- [ ] QQQ Rule B 触发
- [ ] QQQ Rule C 触发
- [ ] QQQ Rule D 触发
- [ ] 期权止盈触发
- [ ] 期权止损触发
- [ ] 时间风险触发
- [ ] 去重机制正常
- [ ] 企业微信推送成功（可选）
- [ ] Polygon.io API 调用成功（可选）

---

## 💡 测试技巧

### 1. 快速测试（不推送）

如果只想测试规则逻辑，不想发送微信推送：

```powershell
python tests/test_alerts.py
# 在提示 "是否测试企业微信推送？" 时输入 n
# 在提示 "是否测试真实的 API 调用？" 时输入 n
```

### 2. 完整测试（包含推送）

如果想测试完整的推送流程：

```powershell
python tests/test_alerts.py
# 在所有提示都输入 y
```

### 3. 测试特定场景

修改 `tests/test_alerts.py` 中的测试数据，可以测试特定场景：

```python
# 例如：测试 0.1% 的小幅跌幅
qqq_data = {
    "last_price": 459.54,  # 跌幅 -0.1%
    "prev_close": 460.00,
    ...
}
```

---

## 🔍 常见问题

### Q1: 测试脚本无法导入模块

**解决方法**：
```powershell
cd "/d/LEAPS Option Alert"
.\venv\Scripts\Activate.ps1
python tests/test_alerts.py
```

### Q2: 企业微信推送失败

**解决方法**：
- 检查 `.env` 文件中的 `WECHAT_WEBHOOK_URL` 是否正确
- 检查企业微信机器人是否已添加到群组
- 检查网络连接

### Q3: Polygon.io API 调用失败

**解决方法**：
- 检查 `.env` 文件中的 `POLYGON_API_KEY` 是否正确
- 检查 API Key 是否已激活
- 检查 API 配额是否已用完（免费版每分钟 5 次）

---

## 📊 测试报告示例

### 测试结果：✅ 通过

```
============================================================
✅ 所有测试完成
============================================================

📊 测试总结:
  ✅ QQQ 跌幅规则测试通过
  ✅ 期权规则测试通过
  ✅ 去重机制测试通过
  ✅ 企业微信推送测试通过

💡 提示:
  - 所有规则逻辑验证完成
  - 如需测试实际提醒，请等待美股交易时段
  - 系统会每 5 分钟自动检查一次
```

---

## 🎯 下一步

测试通过后，您可以：

1. **部署到生产环境**（Oracle VPS）
2. **添加实际期权仓位**
3. **等待美股开盘**，观察实际提醒
4. **根据实际使用调整规则阈值**

---

祝测试顺利！🚀
